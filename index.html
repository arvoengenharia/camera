<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VSR - Câmera</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#111111">

  <!-- Ícones (opcional manter) -->
  <link rel="icon" type="image/png" href="/icons/icon-192.png">

  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0e0e0e; color:#eaeaea; display:flex; flex-direction:column; min-height:100dvh;
    }
    header, footer { padding: 12px 16px; }
    header { background:#121212; border-bottom:1px solid #222; }
    footer { background:#121212; border-top:1px solid #222; font-size:12px; color:#aaa; }
    main { flex:1; padding:16px; display:grid; gap:16px; align-content:start; }
    .card {
      background:#141414; border:1px solid #222; border-radius:16px; padding:16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .row > * { flex: none; }
    button, .btn {
      background:#1f6feb; color:#fff; border:none; border-radius:12px; padding:10px 14px;
      font-weight:600; cursor:pointer;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    input[type=file]{
      background:#0f0f0f; border:1px dashed #2b2b2b; border-radius:12px; padding:10px; color:#bbb;
    }
    #preview { width:100%; max-width:100%; border-radius:12px; border:1px solid #222; display:block; }
    .meta { font-size:13px; color:#bbb; }
    .hint { font-size:12px; color:#8a8a8a; }
    .grid { display:grid; gap:12px; }
  </style>
</head>
<body>
  <header class="row" style="justify-content:space-between;">
    <div><strong>VSR - Câmera</strong></div>
    <div class="meta" id="gpsStatus">GPS: aguardando…</div>
  </header>

  <main class="grid">
    <section class="card grid">
      <div class="row">
        <input id="arquivo" type="file" accept="image/*" capture="environment">
        <button id="btnCamera">Abrir câmera</button>
        <button id="btnSalvar" disabled>Baixar imagem</button>
      </div>
      <div class="meta" id="coordText">Coordenada UTM: —</div>
      <img id="preview" alt="Pré-visualização" />
      <canvas id="canvas" style="display:none"></canvas>
      <div class="hint">
        • Logo inserido de <code>/logo/logo.png</code> (canto superior esquerdo).<br>
        • Textos no canto inferior direito: <em>“Coordenada UTM …”</em> e <em>#Arvo Engenharia</em>.<br>
        • Funciona offline via Service Worker (publique em HTTPS).
      </div>
    </section>
  </main>

  <footer>
    © Arvo Engenharia — PWA de captura com marca d’água
  </footer>

  <!-- proj4 para converter WGS84 -> UTM (mantenha local para offline) -->
  <script src="/libs/proj4.min.js"></script>

  <script>
    // --- PWA: registra Service Worker ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
      });
    }

    const inputArquivo = document.getElementById('arquivo');
    const btnCamera = document.getElementById('btnCamera');
    const btnSalvar = document.getElementById('btnSalvar');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const gpsStatus = document.getElementById('gpsStatus');
    const coordText = document.getElementById('coordText');

    let ultimaImagemDataURL = null;
    let ultimaCoordenadaUTM = null;
    let ultimaWGS84 = null;

    // --- Geolocalização: captura WGS84 contínua para melhor precisão ---
    if ('geolocation' in navigator) {
      gpsStatus.textContent = 'GPS: solicitando…';
      navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          ultimaWGS84 = { latitude, longitude, accuracy };
          gpsStatus.textContent = `GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (±${Math.round(accuracy)}m)`;
          ultimaCoordenadaUTM = wgs84ToUTM(latitude, longitude);
          coordText.textContent = 'Coordenada UTM: ' + ultimaCoordenadaUTM;
        },
        (err) => {
          gpsStatus.textContent = 'GPS: indisponível (' + err.message + ')';
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
      );
    } else {
      gpsStatus.textContent = 'GPS: não suportado';
    }

    // --- Conversão WGS84 -> UTM (string “<Zona><Letra> E N”) ---
    function wgs84ToUTM(lat, lon) {
      try {
        const zone = Math.floor((lon + 180) / 6) + 1;
        const south = lat < 0;
        // Banda UTM aproximada por latitude
        const bands = "CDEFGHJKLMNPQRSTUVWX"; // 80S a 84N (sem I/O)
        const bandIndex = Math.min(Math.max(Math.floor((lat + 80) / 8), 0), bands.length - 1);
        const band = bands[bandIndex];

        const utmProj = `+proj=utm +zone=${zone} ${south ? '+south ' : ''}+datum=WGS84 +units=m +no_defs`;
        const [E, N] = proj4('WGS84', utmProj, [lon, lat]);
        const easting = Math.round(E);
        const northing = Math.round(N);
        return `${zone}${band} ${easting} ${northing}`;
      } catch (e) {
        console.error('Erro UTM:', e);
        return '—';
      }
    }

    // --- Abre a câmera diretamente (em muitos Androids) ---
    btnCamera.addEventListener('click', () => {
      inputArquivo.click();
    });

    // --- Pipeline principal: lê imagem, desenha no canvas, aplica marca e gera preview ---
    inputArquivo.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      await processarImagem(file);
    });

    async function processarImagem(file) {
      // Carrega foto
      const foto = await carregarImagem(URL.createObjectURL(file));

      // Define canvas para a resolução original
      canvas.width = foto.naturalWidth || foto.width;
      canvas.height = foto.naturalHeight || foto.height;
      const ctx = canvas.getContext('2d');

      // Desenha a foto base
      ctx.drawImage(foto, 0, 0, canvas.width, canvas.height);

      // Desenha logo no canto superior esquerdo
      await desenharLogo(ctx, canvas.width, canvas.height, '/logo/logo.png');

      // Monta textos (coordenada UTM + hashtag)
      const utm = ultimaCoordenadaUTM || '—';
      desenharTextos(ctx, canvas.width, canvas.height, `Coordenada UTM: ${utm}`, '#Arvo Engenharia');

      // Exporta JPEG
      ultimaImagemDataURL = canvas.toDataURL('image/jpeg', 0.92);
      preview.src = ultimaImagemDataURL;
      btnSalvar.disabled = false;
    }

    function carregarImagem(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    async function desenharLogo(ctx, W, H, logoPath) {
      try {
        const logo = await carregarImagem(logoPath);
        const margem = Math.round(Math.max(W, H) * 0.012); // margem proporcional
        const alvoLargura = Math.round(W * 0.15); // 15% da largura da foto
        const escala = alvoLargura / logo.width;
        const alvoAltura = Math.round(logo.height * escala);

        // Fundo sutil para garantir leitura do logo em fundos claros/escuros
        const pad = Math.round(alvoLargura * 0.12);
        ctx.save();
        ctx.globalAlpha = 0.35;
        ctx.fillStyle = '#000';
        ctx.fillRect(margem - pad/2, margem - pad/2, alvoLargura + pad, alvoAltura + pad);
        ctx.restore();

        ctx.drawImage(logo, margem, margem, alvoLargura, alvoAltura);
      } catch (e) {
        console.warn('Logo não encontrado em', logoPath, e);
      }
    }

    function desenharTextos(ctx, W, H, linha1, linha2) {
      // Tamanhos proporcionais à imagem
      const fontePx = Math.max(14, Math.round(W * 0.03));
      const margem = Math.round(Math.max(W, H) * 0.02);
      const linhaAltura = Math.round(fontePx * 1.35);

      ctx.font = `${fontePx}px Arial, Helvetica, sans-serif`;
      ctx.textAlign = 'right';
      ctx.textBaseline = 'bottom';

      // Larguras de texto
      const w1 = ctx.measureText(linha1).width;
      const w2 = ctx.measureText(linha2).width;
      const boxW = Math.ceil(Math.max(w1, w2) + margem * 1.5);
      const boxH = Math.ceil(linhaAltura * 2 + margem * 0.5);

      const x2 = W - margem;         // canto direito interno
      const y2 = H - margem;         // canto inferior interno

      // Faixa semitransparente para legibilidade
      ctx.save();
      ctx.globalAlpha = 0.35;
      ctx.fillStyle = '#000';
      ctx.fillRect(x2 - boxW, y2 - boxH, boxW, boxH);
      ctx.restore();

      // Contorno + preenchimento branco
      ctx.lineWidth = Math.max(2, Math.round(fontePx * 0.12));
      ctx.strokeStyle = '#000';
      ctx.fillStyle = '#fff';

      // Linha 1 (acima)
      const yLinha1 = y2 - linhaAltura - Math.round(margem * 0.25);
      ctx.strokeText(linha1, x2 - Math.round(margem * 0.75), yLinha1);
      ctx.fillText(linha1,   x2 - Math.round(margem * 0.75), yLinha1);

      // Linha 2 (embaixo)
      ctx.strokeText(linha2, x2 - Math.round(margem * 0.75), y2 - Math.round(margem * 0.25));
      ctx.fillText(linha2,   x2 - Math.round(margem * 0.75), y2 - Math.round(margem * 0.25));
    }

    // --- Botão salvar (baixa o JPEG gerado) ---
    btnSalvar.addEventListener('click', () => {
      if (!ultimaImagemDataURL) return;
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      a.href = ultimaImagemDataURL;
      a.download = `foto_vsr_${ts}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  </script>
</body>
</html>
