<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GeoCam UTM — Webapp</title>
  <meta name="theme-color" content="#0f172a" />
  <!-- Proj4JS para converter Lat/Lon → UTM -->
  <script src="/proj4.min.js"></script>
  <style>
    :root{
      --bg: #0b1220;           /* fundo escuro elegante */
      --card: rgba(255,255,255,0.06);
      --muted: rgba(255,255,255,0.6);
      --text: #e6eefc;
      --accent: #6ee7ff;      /* ciano suave */
      --accent-2: #a78bfa;     /* lilás */
      --danger: #ff6b6b;
      --ok: #34d399;
      --shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 80% -10%, #182238 0%, #0b1220 55%) no-repeat, var(--bg);
      color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .app{
      width:min(940px, 100%); max-width:940px;
      display:grid; gap:14px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .title{
      display:flex; align-items:center; gap:12px; letter-spacing:0.3px;
    }
    .logo{
      width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--accent-2));
      display:grid; place-items:center; color:#06121c; font-weight:800; box-shadow:var(--shadow);
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:6px 10px; border-radius:999px; background:var(--card); color:var(--muted); box-shadow:var(--shadow); font-size:12px}

    .grid{
      display:grid; grid-template-columns: 1.15fr 0.85fr; gap:14px;
    }
    @media (max-width: 820px){ .grid{ grid-template-columns: 1fr; } }

    .card{ background:var(--card); border:1px solid rgba(255,255,255,0.09); border-radius:20px; box-shadow:var(--shadow); overflow:hidden }
    .card h2{ font-size:14px; letter-spacing:0.4px; margin:0; padding:12px 14px; color:var(--muted); border-bottom:1px solid rgba(255,255,255,0.07)}
    .card .body{ padding:12px; }

    /* Pré-visualização */
    .preview-area{ position:relative; aspect-ratio: 1 / 1; background:#070b14; border-radius:14px; overflow:hidden; }
    video, canvas, img#still{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    canvas, img#still{ display:none; }

    .overlay{
      position:absolute; inset:0; pointer-events:none; background: linear-gradient(to top, rgba(0,0,0,0.18) 0%, rgba(0,0,0,0) 45%);
    }
    .badge-utm{
      position:absolute; left:10px; bottom:10px; pointer-events:none; background:rgba(0,0,0,0.45); color:#c9eaff;
      padding:6px 10px; border-radius:10px; font-size:12px; backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,0.12);
    }

    /* Ações */
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    button, a.button{
      appearance:none; border:none; outline:none; cursor:pointer;
      padding:12px 16px; border-radius:14px; font-weight:600; letter-spacing:0.2px;
      background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      color:var(--text); box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.1);
      text-decoration:none; display:inline-flex; align-items:center; gap:10px;
    }
    button.primary{ background:linear-gradient(180deg, rgba(110,231,255,0.25), rgba(110,231,255,0.09)); color:#04232d; border-color:rgba(110,231,255,0.45) }
    button:disabled{ opacity:0.45; cursor:not-allowed }

    .rows{ display:grid; gap:10px }
    .row{ display:flex; gap:8px; align-items:center; justify-content:space-between; background:rgba(255,255,255,0.04); padding:10px 12px; border-radius:12px; }
    .row .label{ color:var(--muted); font-size:12px }
    .row .value{ font-variant-numeric: tabular-nums; font-weight:700 }

    .ok{ color:var(--ok) }
    .warn{ color:#fbbf24 }
    .err{ color:var(--danger) }
    .muted{ color:var(--muted) }

    footer{ color:var(--muted); font-size:12px; text-align:center; margin-top:6px }
    .tiny{ font-size:11px; color:var(--muted) }
  </style>
  <link rel="manifest" href="/manifest.webmanifest">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo">UTM</div>
        <div>
          <div style="font-weight:800; font-size:18px">GeoCam UTM</div>
          <div class="tiny">Abrir câmera • Capturar • Salvar como <b>#ZonaBand-E-N.jpg</b></div>
        </div>
      </div>
      <div class="chips">
        <span class="chip" id="chipSecure">Verificando HTTPS…</span>
        <span class="chip" id="chipGPS">GPS: —</span>
        <span class="chip" id="chipCam">Câmera: —</span>
      </div>
    </header>

    <div class="grid">
      <!-- Coluna esquerda: câmera/preview -->
      <section class="card">
        <h2>Captura</h2>
        <div class="body">
          <div class="preview-area" id="preview">
            <video id="video" playsinline autoplay muted></video>
            <canvas id="canvas"></canvas>
            <img id="still" alt="Pré-visualização" />
            <div class="overlay"></div>
            <div class="badge-utm" id="badgeUTM">UTM: —</div>
          </div>

          <div class="actions" style="margin-top:12px">
            <button id="btnStart" class="primary">Abrir câmera</button>
            <button id="btnCapture" disabled>Capturar foto</button>
            <button id="btnRefazer" style="display:none">Refazer</button>
            <a id="btnDownload" class="button" style="display:none" download>Salvar foto</a>
          </div>
        </div>
      </section>

      <!-- Coluna direita: dados da localização e nome do arquivo -->
      <section class="card">
        <h2>Localização / UTM</h2>
        <div class="body rows">
          <div class="row"><span class="label">Status GPS</span><span class="value" id="gpsStatus" aria-live="polite">—</span></div>
          <div class="row"><span class="label">Lat, Lon</span><span class="value" id="latlon">—</span></div>
          <div class="row"><span class="label">Precisão</span><span class="value" id="acc">—</span></div>
          <div class="row"><span class="label">Zona & Banda</span><span class="value" id="zoneBand">—</span></div>
          <div class="row"><span class="label">Easting (E)</span><span class="value" id="easting">—</span></div>
          <div class="row"><span class="label">Northing (N)</span><span class="value" id="northing">—</span></div>
          <div class="row"><span class="label">Nome do arquivo</span><span class="value" id="fname">—</span></div>
          <div class="tiny">Dica: aguarde o GPS estabilizar (precisão &lt; 10 m) antes de capturar.</div>
        </div>
      </section>
    </div>

    <footer>Funciona melhor em conexões <b>HTTPS</b> (ou <i>localhost</i>). Permita câmera e localização no navegador.</footer>
  </div>

  <script>
    // Utilidades UTM
    function latBandLetter(lat){
      // bandas: C..X (sem I e O). X tem 12°, as demais 8°.
      const bands = "CDEFGHJKLMNPQRSTUVWX"; // 20 letras
      const capped = Math.max(-80, Math.min(84, lat));
      let index = Math.floor((capped + 80) / 8);
      if(index > 19) index = 19; if(index < 0) index = 0; // segurança
      return bands[index];
    }
    function utmZoneFromLon(lon){
      let z = Math.floor((lon + 180) / 6) + 1;
      // Exceções de Svalbard/Noruega omitidas (irrelevantes para BR)
      if (z < 1) z = 1; if (z > 60) z = 60;
      return z;
    }
    function toUTM(lat, lon){
      const zone = utmZoneFromLon(lon);
      const south = lat < 0;
      const projUTM = `+proj=utm +zone=${zone} ${south?"+south":""} +datum=WGS84 +units=m +no_defs`;
      const result = proj4('EPSG:4326', projUTM, [lon, lat]);
      const e = Math.round(result[0]);
      const n = Math.round(result[1]);
      const band = latBandLetter(lat);
      return { zone, band, e, n };
    }

    // Estado
    const els = {
      chipSecure: document.getElementById('chipSecure'),
      chipGPS: document.getElementById('chipGPS'),
      chipCam: document.getElementById('chipCam'),
      video: document.getElementById('video'),
      canvas: document.getElementById('canvas'),
      still: document.getElementById('still'),
      badgeUTM: document.getElementById('badgeUTM'),
      btnStart: document.getElementById('btnStart'),
      btnCapture: document.getElementById('btnCapture'),
      btnRefazer: document.getElementById('btnRefazer'),
      btnDownload: document.getElementById('btnDownload'),
      gpsStatus: document.getElementById('gpsStatus'),
      latlon: document.getElementById('latlon'),
      acc: document.getElementById('acc'),
      zoneBand: document.getElementById('zoneBand'),
      easting: document.getElementById('easting'),
      northing: document.getElementById('northing'),
      fname: document.getElementById('fname'),
    };

    const state = {
      lat: null, lon: null, acc: null, zone: null, band: null, e: null, n: null,
      stream: null, captureURL: null
    };

    // Secure context chip
    (function(){
      const secure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      els.chipSecure.textContent = secure ? 'HTTPS ✓' : 'Use HTTPS para câmera/GPS';
      els.chipSecure.style.color = secure ? 'var(--ok)' : 'var(--danger)';
    })();

    // GPS: watchPosition para fixar e atualizar em tempo real
    let watchId = null;
    function startGPS(){
      if(!('geolocation' in navigator)){
        els.gpsStatus.innerHTML = '<span class="err">Geolocalização não suportada</span>';
        els.chipGPS.textContent = 'GPS: indisponível';
        return;
      }
      els.gpsStatus.textContent = 'Solicitando permissão…';
      els.chipGPS.textContent = 'GPS: pedindo…';
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        state.lat = latitude; state.lon = longitude; state.acc = accuracy;
        const { zone, band, e, n } = toUTM(latitude, longitude);
        Object.assign(state, { zone, band, e, n });
        updateUI();
      }, err => {
        els.gpsStatus.innerHTML = `<span class="err">${err.message}</span>`;
        els.chipGPS.textContent = 'GPS: negado';
      }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
    }

    function stopGPS(){ if (watchId!==null) { navigator.geolocation.clearWatch(watchId); watchId=null; } }

    // Câmera
    async function startCamera(){
      try{
        els.btnStart.disabled = true; els.btnStart.textContent = 'Abrindo câmera…';
        const constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        state.stream = stream;
        els.video.srcObject = stream;
        await els.video.play();
        els.btnCapture.disabled = false;
        els.chipCam.textContent = 'Câmera: ativa'; els.chipCam.style.color = 'var(--ok)';
        els.btnStart.textContent = 'Câmera ativa';
      }catch(e){
        console.error(e);
        els.chipCam.textContent = 'Câmera: erro'; els.chipCam.style.color = 'var(--danger)';
        alert('Não foi possível acessar a câmera. Verifique permissões do navegador.');
        els.btnStart.disabled = false; els.btnStart.textContent = 'Abrir câmera';
      }
    }

    function stopCamera(){
      if(state.stream){
        state.stream.getTracks().forEach(t => t.stop());
        state.stream = null;
      }
    }

    function updateUI(){
      const { lat, lon, acc, zone, band, e, n } = state;
      if(lat!=null && lon!=null){
        els.latlon.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        els.acc.textContent = acc!=null ? `${Math.round(acc)} m` : '—';
        els.zoneBand.textContent = (zone?zone:'—') + (band?band:'');
        els.easting.textContent = e!=null ? e : '—';
        els.northing.textContent = n!=null ? n : '—';
        if(zone && band && e!=null && n!=null){
          const fileBase = `#${zone}${band}-${e}-${n}`; // sem .jpg aqui
          els.fname.textContent = `${fileBase}.jpg`;
          els.badgeUTM.textContent = `UTM: ${fileBase}`;
          els.gpsStatus.innerHTML = `<span class="ok">Fixado</span>`;
          els.chipGPS.textContent = `GPS: ±${Math.round(acc||0)} m`;
          els.chipGPS.style.color = 'var(--ok)';
        }
      }
    }

    async function capturePhoto(){
      if(!state.stream){ alert('Câmera inativa. Toque em "Abrir câmera".'); return; }
      if(state.lat==null || state.lon==null){ alert('Localização ainda não disponível. Aguarde o GPS fixar.'); return; }

      // Desenhar frame no canvas com resolução do vídeo
      const vw = els.video.videoWidth, vh = els.video.videoHeight;
      const s = Math.min(vw, vh), sx = (vw - s)/2, sy = (vh - s)/2;
      els.canvas.width = s; els.canvas.height = s;
      const ctx = els.canvas.getContext('2d');
      ctx.drawImage(els.video, sx, sy, s, s, 0, 0, s, s);

      // Gerar Blob JPEG
      els.canvas.toBlob(async (blob)=>{
        if(!blob){ alert('Falha ao gerar imagem.'); return; }
        const { zone, band, e, n } = state;
        const base = `#${zone}${band}-${e}-${n}`;
        const fileName = `${base}.jpg`;

        // Mostrar "still" e esconder o vídeo
        els.still.src = URL.createObjectURL(blob);
        els.still.style.display = 'block';
        els.canvas.style.display = 'none'; // canvas não precisa aparecer
        els.video.style.display = 'none';
        els.btnRefazer.style.display = 'inline-flex';
        els.btnDownload.style.display = 'inline-flex';
        els.btnDownload.textContent = `Salvar: ${fileName}`;
        els.btnDownload.setAttribute('download', fileName);

        // Preferir usar o blob direto para download
        if(state.captureURL) URL.revokeObjectURL(state.captureURL);
        state.captureURL = URL.createObjectURL(blob);
        els.btnDownload.href = state.captureURL;
      }, 'image/jpeg', 0.92);
    }

    function refazer(){
      els.still.style.display = 'none';
      els.video.style.display = 'block';
      els.btnRefazer.style.display = 'none';
      els.btnDownload.style.display = 'none';
    }

    // Ligações de UI
    els.btnStart.addEventListener('click', async ()=>{
      // Start GPS e Câmera juntos após gesto do usuário (melhor para permissões iOS/Android)
      startGPS();
      await startCamera();
    });
    els.btnCapture.addEventListener('click', capturePhoto);
    els.btnRefazer.addEventListener('click', refazer);

    // Limpeza quando sair
    window.addEventListener('beforeunload', ()=>{ stopCamera(); stopGPS(); if(state.captureURL) URL.revokeObjectURL(state.captureURL); });

    // Sinalizar suporte
    if(!('mediaDevices' in navigator)){
      els.chipCam.textContent = 'Câmera: não suportada'; els.chipCam.style.color='var(--danger)';
    } else {
      els.chipCam.textContent = 'Câmera: pronta';
    }
  </script>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('/sw.js');
  });
}
</script>
</body>
</html>
