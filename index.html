<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GeoCam UTM</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a">

  <!-- Proj4 local (garante offline) -->
  <script src="./proj4.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;--text:#e6eefc;--muted:#9bb0d9;--card:rgba(255,255,255,0.06);
      --ok:#34d399;--danger:#ff6b6b;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#0b1220;color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial;}
    .wrap{max-width:920px;margin:0 auto;padding:16px;display:grid;gap:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#6ee7ff,#a78bfa);display:grid;place-items:center;color:#08202a;font-weight:800}
    .chip{font-size:12px;color:var(--muted);background:var(--card);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;font-size:14px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,.08)}
    .card .body{padding:12px}
    .preview{position:relative;background:#070b14;border-radius:12px;overflow:hidden;aspect-ratio:1/1}
    video,canvas,img#still{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    canvas,img#still{display:none}
    .overlay{position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.18), transparent 45%)}
    .badge{position:absolute;left:10px;bottom:10px;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:10px;font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button,a.button{appearance:none;border:none;background:rgba(255,255,255,.10);color:var(--text);padding:12px 14px;border-radius:12px;font-weight:600;text-decoration:none}
    button.primary{background:linear-gradient(180deg, rgba(110,231,255,.25), rgba(110,231,255,.09));color:#06232b}
    button:disabled{opacity:.45;cursor:not-allowed}
    .row{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:rgba(255,255,255,.04);border-radius:10px;margin-bottom:8px}
    .lbl{font-size:12px;color:var(--muted)} .val{font-variant-numeric:tabular-nums;font-weight:700}
    footer{font-size:12px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo">UTM</div>
        <div>
          <div style="font-weight:800">GeoCam UTM</div>
          <div style="font-size:12px;color:#9bb0d9">Câmera • GPS • Salvar #ZonaBanda-E-N.jpg</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <span id="chipSecure" class="chip">HTTPS…</span>
        <span id="chipGPS" class="chip">GPS: —</span>
        <span id="chipCam" class="chip">Câmera: —</span>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Captura</h2>
        <div class="body">
          <div class="preview">
            <video id="video" playsinline autoplay muted></video>
            <canvas id="canvas"></canvas>
            <img id="still" alt="Prévia"/>
            <div class="overlay"></div>
            <div id="badge" class="badge">UTM: —</div>
          </div>
          <div class="actions">
            <button id="btnStart" class="primary">Abrir câmera</button>
            <button id="btnShot" disabled>Capturar foto</button>
            <button id="btnRedo" style="display:none">Refazer</button>
            <a id="btnSave" class="button" style="display:none" download>Salvar</a>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Localização / UTM</h2>
        <div class="body">
          <div class="row"><span class="lbl">Status GPS</span><span class="val" id="gpsStatus">—</span></div>
          <div class="row"><span class="lbl">Lat, Lon</span><span class="val" id="latlon">—</span></div>
          <div class="row"><span class="lbl">Precisão</span><span class="val" id="acc">—</span></div>
          <div class="row"><span class="lbl">Zona & Banda</span><span class="val" id="zoneBand">—</span></div>
          <div class="row"><span class="lbl">Easting (E)</span><span class="val" id="easting">—</span></div>
          <div class="row"><span class="lbl">Northing (N)</span><span class="val" id="northing">—</span></div>
          <div class="row"><span class="lbl">Nome do arquivo</span><span class="val" id="fname">—</span></div>
          <div style="font-size:12px;color:#9bb0d9">Dica: aguarde precisão &lt; 10 m antes de capturar.</div>
        </div>
      </section>
    </div>

    <footer>Permita câmera e localização. Melhor em HTTPS (ou localhost).</footer>
  </div>

  <script>
    // Sinaliza contexto seguro
    (function(){
      const el = document.getElementById('chipSecure');
      const ok = location.protocol==='https:' || ['localhost','127.0.0.1'].includes(location.hostname);
      el.textContent = ok ? 'HTTPS ✓' : 'Use HTTPS';
      el.style.color = ok ? 'var(--ok)' : 'var(--danger)';
    })();

    // ---- UTM helpers ----
    function latBandLetter(lat){
      const bands = "CDEFGHJKLMNPQRSTUVWX";
      const capped = Math.max(-80, Math.min(84, lat));
      let idx = Math.floor((capped + 80) / 8);
      if(idx<0) idx=0; if(idx>19) idx=19;
      return bands[idx];
    }
    function utmZoneFromLon(lon){
      let z = Math.floor((lon + 180) / 6) + 1;
      if(z<1) z=1; if(z>60) z=60;
      return z;
    }
    function toUTM(lat, lon){
      const zone = utmZoneFromLon(lon);
      const south = lat < 0;
      const def = `+proj=utm +zone=${zone} ${south?'+south':''} +datum=WGS84 +units=m +no_defs`;
      const [E,N] = proj4('EPSG:4326', def, [lon, lat]);
      return { zone, band: latBandLetter(lat), e: Math.round(E), n: Math.round(N) };
    }

    // ---- Estado/UI ----
    const els = {
      chipGPS: document.getElementById('chipGPS'),
      chipCam: document.getElementById('chipCam'),
      video: document.getElementById('video'),
      canvas: document.getElementById('canvas'),
      still: document.getElementById('still'),
      badge: document.getElementById('badge'),
      btnStart: document.getElementById('btnStart'),
      btnShot: document.getElementById('btnShot'),
      btnRedo: document.getElementById('btnRedo'),
      btnSave: document.getElementById('btnSave'),
      gpsStatus: document.getElementById('gpsStatus'),
      latlon: document.getElementById('latlon'),
      acc: document.getElementById('acc'),
      zoneBand: document.getElementById('zoneBand'),
      easting: document.getElementById('easting'),
      northing: document.getElementById('northing'),
      fname: document.getElementById('fname'),
    };
    const state = { lat:null, lon:null, acc:null, zone:null, band:null, e:null, n:null, stream:null, captureURL:null };
    let watchId = null;

    function updateUI(){
      const {lat,lon,acc,zone,band,e,n} = state;
      if(lat!=null && lon!=null){
        els.latlon.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
        els.acc.textContent = acc!=null ? `${Math.round(acc)} m` : '—';
        els.zoneBand.textContent = (zone?zone:'—') + (band?band:'');
        els.easting.textContent = e ?? '—';
        els.northing.textContent = n ?? '—';
        if(zone && band && e!=null && n!=null){
          const base = `#${zone}${band}-${e}-${n}`;
          els.fname.textContent = `${base}.jpg`;
          els.badge.textContent = `UTM: ${base}`;
          els.gpsStatus.innerHTML = '<span style="color:var(--ok)">Fixado</span>';
          els.chipGPS.textContent = `GPS: ±${Math.round(acc||0)} m`; els.chipGPS.style.color='var(--ok)';
        }
      }
    }

    function startGPS(){
      if(!('geolocation' in navigator)){
        els.gpsStatus.innerHTML = '<span style="color:var(--danger)">Sem geolocalização</span>';
        els.chipGPS.textContent = 'GPS: indisponível'; return;
      }
      els.gpsStatus.textContent = 'Solicitando permissão…';
      els.chipGPS.textContent = 'GPS: pedindo…';
      watchId = navigator.geolocation.watchPosition(p=>{
        const {latitude, longitude, accuracy} = p.coords;
        Object.assign(state, {lat:latitude, lon:longitude, acc:accuracy}, toUTM(latitude, longitude));
        updateUI();
      }, err=>{
        els.gpsStatus.innerHTML = `<span style="color:var(--danger)">${err.message}</span>`;
        els.chipGPS.textContent = 'GPS: negado';
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    }

    async function startCamera(){
      try{
        els.btnStart.disabled = true; els.btnStart.textContent = 'Abrindo câmera…';
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080} }, audio:false
        });
        state.stream = stream; els.video.srcObject = stream; await els.video.play();
        els.btnShot.disabled = false; els.chipCam.textContent = 'Câmera: ativa'; els.chipCam.style.color='var(--ok)';
        els.btnStart.textContent = 'Câmera ativa';
      }catch(e){
        console.error(e); els.chipCam.textContent='Câmera: erro'; els.chipCam.style.color='var(--danger)';
        alert('Não foi possível acessar a câmera. Verifique permissões.');
        els.btnStart.disabled=false; els.btnStart.textContent='Abrir câmera';
      }
    }

    async function capturePhoto(){
      if(!state.stream){ alert('Câmera inativa. Toque em "Abrir câmera".'); return; }
      if(state.lat==null || state.lon==null){ alert('Aguarde o GPS fixar.'); return; }
      const vw = els.video.videoWidth, vh = els.video.videoHeight; if(!vw||!vh){ alert('Câmera iniciando…'); return; }
      // Recorte central quadrado (1:1)
      const s = Math.min(vw, vh), sx = (vw - s)/2, sy = (vh - s)/2;
      els.canvas.width = s; els.canvas.height = s;
      const ctx = els.canvas.getContext('2d'); ctx.drawImage(els.video, sx, sy, s, s, 0, 0, s, s);

      els.canvas.toBlob((blob)=>{
        if(!blob){ alert('Falha ao gerar imagem.'); return; }
        const base = `#${state.zone}${state.band}-${state.e}-${state.n}`;
        const fname = `${base}.jpg`;
        if(state.captureURL) URL.revokeObjectURL(state.captureURL);
        const url = URL.createObjectURL(blob); state.captureURL = url;

        els.still.src = url; els.still.style.display='block';
        els.video.style.display='none'; els.canvas.style.display='none';
        els.btnRedo.style.display='inline-flex'; els.btnSave.style.display='inline-flex';
        els.btnSave.textContent = `Salvar: ${fname}`; els.btnSave.href = url; els.btnSave.setAttribute('download', fname);
      }, 'image/jpeg', 0.92);
    }

    function redo(){
      els.still.style.display='none'; els.video.style.display='block';
      els.btnRedo.style.display='none'; els.btnSave.style.display='none';
    }

    function stopAll(){
      if (watchId!=null) { navigator.geolocation.clearWatch(watchId); watchId=null; }
      if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); state.stream=null; }
      if(state.captureURL){ URL.revokeObjectURL(state.captureURL); state.captureURL=null; }
    }

    els.btnStart.addEventListener('click', ()=>{ startGPS(); startCamera(); });
    els.btnShot.addEventListener('click', capturePhoto);
    els.btnRedo.addEventListener('click', redo);
    window.addEventListener('beforeunload', stopAll);

    // Service Worker (escopo relativo à subpasta)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
    }

    // Estado inicial
    if(!('mediaDevices' in navigator)){ els.chipCam.textContent='Câmera: não suportada'; els.chipCam.style.color='var(--danger)'; }
    else { els.chipCam.textContent='Câmera: pronta'; }
  </script>
</body>
</html>
